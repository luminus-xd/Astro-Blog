---
import { db, Like, eq } from 'astro:db';

type Props = {
    articleId: string;
};

const { articleId } = Astro.props;

export const prerender = false;

const likes = await db.select().from(Like).where(eq(Like.articleId, articleId));
const likesCount = likes.length;
---

<button id="like-btn" data-article-id={articleId} type="button">
    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 256">
        <path
            fill="currentColor"
            d="M240 94c0 70-103.79 126.66-108.21 129a8 8 0 0 1-7.58 0C119.79 220.66 16 164 16 94a62.07 62.07 0 0 1 62-62c20.65 0 38.73 8.88 50 23.89C139.27 40.88 157.35 32 178 32a62.07 62.07 0 0 1 62 62"
        ></path>
    </svg>
    <span>いいね <span id="like-span">{likesCount}</span></span>
</button>

<script>
    const likeBtn = document.querySelector('#like-btn') as HTMLButtonElement;
    const likeText = document.querySelector('#like-span');
    const id = likeBtn.dataset.articleId;

    if (id) {
        likeBtn.addEventListener('click', async () => {
            console.log('test');
            likeBtn.disabled = true;
            // @ts-ignore
            likeText.textContent = (++likeText.textContent).toString();

            // const jsconfetti = new JSConfetti();
            // jsconfetti.addConfetti();

            try {
                const req = await fetch('/api/addLike.json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id,
                    }),
                });

                console.log(req);

                // save to locale storage for already liked
                localStorage.setItem(id, 'true');
            } catch (e) {
                console.error(e);
            }
        });
    }
</script>

<style>
    button {
        display: flex;
        height: 100%;
        background-color: var(--color-text-main);
        border: none;
        cursor: pointer;
        padding: 12px;
        appearance: none;
        justify-content: center;
        align-items: center;
        line-height: 1;
        gap: 8px;
        border-radius: 30px;
        font-size: 1.1em;
        font-family: var(--font-family-primary);
        font-weight: bold;
    }
    button svg {
        transform: scale(1.4);
    }
    button svg path {
        fill: #982e2a;
    }
</style>
